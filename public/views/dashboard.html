<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CBI - Executive Analytics Portal</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #004d99; /* CBI Navy */
      --accent: #e31e24;  /* CBI Red */
      --success: #059669;
      --warning: #f59e0b;
      --danger: #dc2626;
      --bg-light: #f1f5f9;
      --white: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-main); padding: 30px; }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e2e8f0;
    }
    .brand-section h1 { font-size: 1.8rem; color: var(--primary); font-weight: 800; }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .kpi-card {
      background: var(--white);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border-left: 6px solid var(--primary);
    }
    .kpi-label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    .kpi-value { font-size: 2.2rem; font-weight: 800; color: var(--primary); margin-top: 8px; display: block; }

    .filter-panel {
      background: var(--white);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: flex-end;
    }
    .filter-group { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 160px; }
    .filter-group label { font-size: 0.8rem; font-weight: 600; }
    input, select { padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; font-family: inherit; width: 100%; }

    .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; text-decoration: none; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
    .btn-excel { background: #1D6F42; color: white; display: flex; align-items: center; gap: 8px; }

    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    .card { background: var(--white); padding: 25px; border-radius: var(--radius); box-shadow: var(--shadow); }
    .card h3 { font-size: 1.1rem; margin-bottom: 20px; color: var(--primary); border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }

    .rank-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
    .rank-name { font-weight: 600; }
    .rank-score { font-weight: 800; }

    .factor-item { margin-bottom: 15px; }
    .factor-label { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
    .progress-bg { background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease-out; }

    .table-container { background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; margin-top: 20px; }
    .table-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
    table { width: 100%; border-collapse: collapse; min-width: 1200px; }
    th { text-align: left; padding: 16px; background: #f8fafc; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
    td { padding: 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }
    .comment-cell { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-style: italic; color: var(--text-muted); }

    @media print {
      .filter-panel, .btn, .header-bar button, .table-container { display: none !important; }
      body { background: white; padding: 0; }
      .analysis-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>

  <header class="header-bar">
    <div class="brand-section">
      <h1>CBI Executive Analytics</h1>
      <p>Performance Intelligence & Global Factor Dashboard</p>
    </div>
    <div style="display: flex; gap: 10px;">
        <a href="views/marketinglead" class="btn btn-outline">View Marketing Leads</a>
        <button class="btn btn-primary" onclick="window.print()">Download Report</button>
    </div>
  </header>

  <div class="kpi-row">
    <div class="kpi-card">
      <span class="kpi-label">Total Submissions</span>
      <span class="kpi-value" id="totalCount">0</span>
    </div>
    <div class="kpi-card" style="border-left-color: var(--success)">
      <span class="kpi-label">Transparency Rate</span>
      <span class="kpi-value" id="trustRate">0%</span>
    </div>
    <div class="kpi-card" style="border-left-color: var(--warning)">
      <span class="kpi-label">Identified Leads</span>
      <span class="kpi-value" id="leadCount">0</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">Avg. Satisfaction</span>
      <span class="kpi-value" id="avgRating">0.0 ‚òÖ</span>
    </div>
  </div>

  <div class="filter-panel">
    <div class="filter-group">
      <label>Region</label>
      <select id="regFilter">
        <option value="">All Regions</option>
        <option>Bhopal</option><option>Indore</option><option>Gwalior</option><option>Jabalpur</option><option>Sagar</option><option>Ratlam</option>
      </select>
    </div>
    <div class="filter-group">
      <label>Search Branch</label>
      <input type="text" id="brSearch" placeholder="Branch name...">
    </div>
    <div class="filter-group">
      <label>From Date</label>
      <input type="date" id="dateFrom">
    </div>
    <div class="filter-group">
      <label>To Date</label>
      <input type="date" id="dateTo">
    </div>
    <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
  </div>

  <div class="analysis-grid">
    <div class="card">
      <h3>üìä Service Factor Health</h3>
      <div id="factorContainer">
        <div class="factor-item">
          <div class="factor-label"><span>Hygiene (Cleanliness)</span><span id="f-clean">0.0</span></div>
          <div class="progress-bg"><div id="p-clean" class="progress-fill" style="background:var(--success)"></div></div>
        </div>
        <div class="factor-item">
          <div class="factor-label"><span>Service (Staff Behavior)</span><span id="f-staff">0.0</span></div>
          <div class="progress-bg"><div id="p-staff" class="progress-fill" style="background:var(--primary)"></div></div>
        </div>
        <div class="factor-item">
          <div class="factor-label"><span>Resolution Efficiency</span><span id="f-res">0%</span></div>
          <div class="progress-bg"><div id="p-res" class="progress-fill" style="background:var(--warning)"></div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>üèÜ Top 3 Performers</h3>
      <div id="topBranches"></div>
    </div>

    <div class="card">
      <h3>‚ö†Ô∏è Priority Improvements</h3>
      <div id="poorBranches"></div>
    </div>
  </div>

  <div class="table-container">
    <div class="table-header">
      <h3>Detailed Customer Feedback Log</h3>
      <button class="btn btn-excel" onclick="exportToExcel()">üìä Export to Excel</button>
    </div>
    <div style="overflow-x: auto;">
      <table id="feedbackTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Branch</th>
            <th>Trust (Q5)</th>
            <th>Res.</th>
            <th>Clean.</th>
            <th>Staff</th>
            <th>Rating</th>
            <th>Interest (Q6)</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
  const API_URL = "https://survey-backend.gudgudi36garh.workers.dev/api/responses";
  let allData = [];

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Helpers
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getRecordDate(item) {
    if (!item.created_at) return null;
    const d = new Date(item.created_at);
    return isNaN(d) ? null : d;
  }

  function formatDate(d) {
    return d ? d.toLocaleDateString() : "Old Record";
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Init
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function init() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error("API failed");
      allData = await res.json();
      applyFilters();
    } catch (e) {
      console.error("Data load failed", e);
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Filters
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function applyFilters() {
    const reg = document.getElementById("regFilter").value;
    const br = document.getElementById("brSearch").value.toLowerCase();
    const from = document.getElementById("dateFrom").value;
    const to = document.getElementById("dateTo").value;

    const filtered = allData.filter(item => {
      const d = getRecordDate(item);

      if (from && (!d || d < new Date(from))) return false;
      if (to && (!d || d > new Date(to))) return false;
      if (reg && item.region !== reg) return false;
      if (br && !(item.branch || "").toLowerCase().includes(br)) return false;

      return true;
    });

    updateKPIs(filtered);
    performFactorAnalysis(filtered);
    renderRankings(filtered);
    renderTable(filtered);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // KPIs
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateKPIs(data) {
    document.getElementById("totalCount").innerText = data.length;

    const avg =
      data.length > 0
        ? (
            data.reduce((sum, i) => sum + Number(i.overall || 0), 0) /
            data.length
          ).toFixed(1)
        : "0.0";

    document.getElementById("avgRating").innerText = `${avg} ‚òÖ`;

    const trustRate = data.length
      ? Math.round(
          (data.filter(i => i.transparency === "Yes").length / data.length) *
            100
        )
      : 0;

    document.getElementById("trustRate").innerText = `${trustRate}%`;

    document.getElementById("leadCount").innerText = data.filter(
      i => i.future_product && i.future_product.trim()
    ).length;
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Factor Analysis
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function performFactorAnalysis(data) {
    if (!data.length) return;

    const avgClean =
      data.reduce((a, b) => a + Number(b.cleanliness || 0), 0) / data.length;
    const avgStaff =
      data.reduce((a, b) => a + Number(b.staff_behavior || 0), 0) /
      data.length;
    const resRate =
      (data.filter(i => i.timely === "Yes").length / data.length) * 100;

    document.getElementById("f-clean").innerText = `${avgClean.toFixed(1)} / 5.0`;
    document.getElementById("p-clean").style.width = `${(avgClean / 5) * 100}%`;

    document.getElementById("f-staff").innerText = `${avgStaff.toFixed(1)} / 5.0`;
    document.getElementById("p-staff").style.width = `${(avgStaff / 5) * 100}%`;

    document.getElementById("f-res").innerText = `${Math.round(resRate)}%`;
    document.getElementById("p-res").style.width = `${resRate}%`;
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Rankings
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderRankings(data) {
    const stats = {};

    data.forEach(i => {
      if (!i.branch) return;
      stats[i.branch] ??= { sum: 0, count: 0 };
      stats[i.branch].sum += Number(i.overall || 0);
      stats[i.branch].count++;
    });

    const ranked = Object.entries(stats)
      .map(([name, v]) => ({ name, avg: (v.sum / v.count).toFixed(1) }))
      .sort((a, b) => b.avg - a.avg);

    document.getElementById("topBranches").innerHTML = ranked
      .slice(0, 3)
      .map(
        b =>
          `<div class="rank-item"><span class="rank-name">${b.name}</span>
           <span class="rank-score" style="color:var(--success)">${b.avg} ‚òÖ</span></div>`
      )
      .join("");

    document.getElementById("poorBranches").innerHTML = ranked
      .slice(-3)
      .map(
        b =>
          `<div class="rank-item"><span class="rank-name">${b.name}</span>
           <span class="rank-score" style="color:var(--danger)">${b.avg} ‚òÖ</span></div>`
      )
      .join("");
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Table
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderTable(data) {
    const tbody = document.querySelector("#feedbackTable tbody");

    tbody.innerHTML = data
      .map(i => {
        const d = formatDate(getRecordDate(i));
        return `
          <tr>
            <td>${d}</td>
            <td style="font-weight:700;color:var(--primary)">${i.branch || "-"}</td>
            <td style="text-align:center">${i.transparency === "Yes" ? "‚úÖ" : "‚ùå"}</td>
            <td style="font-weight:700">${i.timely === "Yes" ? "Yes" : "No"}</td>
            <td>${i.cleanliness || 0} ‚òÖ</td>
            <td>${i.staff_behavior || 0} ‚òÖ</td>
            <td><b>${i.overall || 0} ‚òÖ</b></td>
            <td>${i.future_product || "-"}</td>
            <td class="comment-cell">${i.comments || "N/A"}</td>
          </tr>
        `;
      })
      .join("");
  }

  init();
</script>

</body>

</html>




